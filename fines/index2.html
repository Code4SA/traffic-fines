<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
    <head>
        <link rel="stylesheet" href="bootstrap.min.css">
        <link rel="stylesheet" href="base.css">
    </head>
<body>
    <div class="container">

        <div class="row">
            <h2 class="text-center">N1: Cape Town to Johannesburg</h2>
        </div>

        <div class="row">
            <div id="n1-jhbcpt" class="col-md-12 text-center"></div>
        </div>
        <div class="row">
            <h2 class="text-center">N2: Cape Town to Durban</h2>
        </div>

        <div class="row">
            <div id="n2-cptplet" class="col-md-12 text-center"></div>
        </div>
        <div class="row">
            <h2 class="text-center">N3: Johannesburg to Durban</h2>
        </div>

        <div class="row">
            <div id="n3-jhbeth" class="col-md-12 text-center"></div>
        </div>
        <div class="row">
            <div class="col-md-2"></div>
            <div id="pie_label" class="col-md-8">
            The size of the bubble compares the fines as a percentage of total budget with the national average. 2x means that this municipalities earns relatively twice as much as the national average. For comparison sake, this is the bubble for the national average: 
<div id="natbubble" style="position:relative; top:50%; transform:translateY(-50%)">National Average:</div>
            </div>
            <div class="col-md-2"></div>
        </div>
    </div>

    <!-- [if IE]><!-->
    <script src="d3.v3.js" type="text/javascript" charset="utf-8"></script>
    <script src="labeler.js" type="text/javascript" charset="utf-8"></script>
    <script src="fines.js" type="text/javascript" charset="utf-8"></script>
    <script>
        var min_radius = 2;
        var max_radius = 150;
        var width = "100%", height = 200;

        var click_pie = function(el, idx) {
            d3.select("#pie_label").selectAll("p").remove()    
            d3.select("#pie_label").append("p").text(el["Name"]);
        }

        MunicBubble.prototype.style = function() {
            this.element.select("circle")
                .style("fill", "#ff2b2b")
                .style("stroke", "#343434")
                .style("stroke-width", "1.0")
                .style("cursor", "pointer")

            this.element.selectAll("text")
                .style("font-family", "'Helvetica Neue', Helvetica, Arial, sans-serif")
                .style("cursor", "pointer")

            return this;
        }

        RoadLayout.prototype.style = function() {
            this.element.selectAll(".road")
                .style("stroke", "#343434")
                .style("stroke-width", "2")
                .style("fill", "#000000")

            this.element.selectAll("rect[data-province=" + "WC" + "]")
                .style("fill", "#435678")
                .style("opacity", "0.4")
            this.element.selectAll("rect[data-province=" + "NC" + "]")
                .style("fill", "#862346")
                .style("opacity", "0.4")
            this.element.selectAll("rect[data-province=" + "FS" + "]")
                .style("fill", "#125743")
                .style("opacity", "0.4")
            this.element.selectAll("rect[data-province=" + "GT" + "]")
                .style("fill", "#642376")
                .style("opacity", "0.4")
            this.element.selectAll("rect[data-province=" + "EC" + "]")
                .style("fill", "#73418")
                .style("opacity", "0.4")
            this.element.selectAll("rect[data-province=" + "KZN" + "]")
                .style("fill", "#bac423")
                .style("opacity", "0.4")
            this.element.selectAll("rect[data-province=" + "MP" + "]")
                .style("fill", "#b168af")
                .style("opacity", "0.4")
        }

        var bubblefactory = function(relative, min_radius, max_radius) {
            return function(root, datum) {
                return new MunicBubble(root, datum, relative, min_radius, max_radius)
                    .style()
                    .addClickObserver(click_pie);
            }
        }

        var add_route = function(route, row, national_average) {
            var charts = row
                    .append("svg")
                        .attr("width", width)
                        .attr("height", height)

            var road_layout = new RoadLayout({
                factory : bubblefactory(national_average, min_radius, max_radius),
                data : route.munics,
                height : height,
                width : width
            }, charts)

            return road_layout;
        }

        d3.csv("data.csv", function(data) {
            var municipalities = new Municipalities(data);
            console.log(municipalities);
            var natdata = municipalities.subset(["Summary"]).munics[0];
            var national_ratio = (natdata["Total Fines"] / natdata["Total Budget"]) * 100;

            add_route(municipalities.subset(n1_cpt_jhb), d3.select("#n1-jhbcpt"), national_ratio);
            add_route(municipalities.subset(n2_cpt_plet), d3.select("#n2-cptplet"), national_ratio);
            add_route(municipalities.subset(n3_jhb_eth), d3.select("#n3-jhbeth"), national_ratio);
        });

    </script>
    <!--<![endif]-->
</body>
</html>
